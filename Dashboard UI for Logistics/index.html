<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food & Medicine Rescue - Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .nav-sidebar {
            width: 250px;
            background: #1a202c;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .brand {
            padding: 24px 20px;
            border-bottom: 1px solid #2d3748;
        }

        .brand h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .brand p {
            font-size: 12px;
            color: #a0aec0;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #cbd5e0;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: #2d3748;
            color: white;
        }

        .nav-item.active {
            background: #3182ce;
            color: white;
            border-left: 4px solid #63b3ed;
        }

        .nav-icon {
            font-size: 20px;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: white;
            padding: 16px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3182ce;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page-content.map-page {
            padding: 0;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-card h4 {
            font-size: 14px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .stat-card .change {
            font-size: 13px;
            color: #48bb78;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge.danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5282;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .map-container {
            padding: 24px;
        }

        #mapView {
            height: 500px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1;
        }

        .map-controls {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .map-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .map-stat-item {
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .map-stat-item h5 {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
        }

        .map-stat-item .value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .pickup-list {
            margin-top: 20px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .pickup-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid #e53e3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pickup-item-info {
            flex: 1;
        }

        .pickup-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .chart-placeholder {
            height: 300px;
            background: #f7fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 14px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            min-width: 300px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #e53e3e;
        }

        .toast.warning {
            border-left: 4px solid #ed8936;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .leaflet-routing-container {
            display: none;
        }

        .coord-input-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .coord-input-section h4 {
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .input-small {
            padding: 8px 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast">
        <div id="toastMessage"></div>
    </div>

    <div class="main-container">
        <div class="nav-sidebar">
            <div class="brand">
                <h2>üçé Food Rescue</h2>
                <p>Logistics Optimizer</p>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="map">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span>Route Optimizer</span>
                </div>
                <div class="nav-item" data-page="pickups">
                    <span class="nav-icon">üì¶</span>
                    <span>Pickup Requests</span>
                </div>
                <div class="nav-item" data-page="ngos">
                    <span class="nav-icon">üè•</span>
                    <span>NGO Partners</span>
                </div>
                <div class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="topbar">
                <h1 id="pageTitle">Dashboard Overview</h1>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Admin User</div>
                        <div style="font-size: 12px; color: #718096;">Coordinator</div>
                    </div>
                </div>
            </div>

            <div class="page-content" id="pageContentArea">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Total Pickups</h4>
                            <div class="value">247</div>
                            <div class="change">+12% from last month</div>
                        </div>
                        <div class="stat-card">
                            <h4>Food Saved (kg)</h4>
                            <div class="value">3,842</div>
                            <div class="change">+18% from last month</div>
                        </div>
                        <div class="stat-card">
                            <h4>Active NGOs</h4>
                            <div class="value">18</div>
                            <div class="change">+2 new partners</div>
                        </div>
                        <div class="stat-card">
                            <h4>Pending Requests</h4>
                            <div class="value">12</div>
                            <div class="change" style="color: #e53e3e;">Needs attention</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Recent Activity</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Donor</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#1247</td>
                                    <td>Restaurant ABC</td>
                                    <td>Cooked Food</td>
                                    <td>45 kg</td>
                                    <td><span class="badge success">Completed</span></td>
                                    <td>2 hours ago</td>
                                </tr>
                                <tr>
                                    <td>#1246</td>
                                    <td>Hotel XYZ</td>
                                    <td>Raw Vegetables</td>
                                    <td>30 kg</td>
                                    <td><span class="badge warning">In Transit</span></td>
                                    <td>4 hours ago</td>
                                </tr>
                                <tr>
                                    <td>#1245</td>
                                    <td>Supermarket 123</td>
                                    <td>Packaged Food</td>
                                    <td>60 kg</td>
                                    <td><span class="badge info">Scheduled</span></td>
                                    <td>6 hours ago</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Map Page with Coordinate Inputs -->
                <div id="map" class="page">
                    <div class="map-container">
                        <div id="mapView"></div>
                    </div>

                    <div class="map-controls">
                        <div class="map-stats">
                            <div class="map-stat-item">
                                <h5>Your Location</h5>
                                <div class="value" id="userLocation" style="font-size: 14px;">Getting...</div>
                            </div>
                            <div class="map-stat-item">
                                <h5>NGO Centers</h5>
                                <div class="value" id="ngoCount">0</div>
                            </div>
                            <div class="map-stat-item">
                                <h5>Pickup Points</h5>
                                <div class="value" id="pickupCount">0</div>
                            </div>
                        </div>

                        <!-- Coordinate Input Section -->
                        <div class="coord-input-section">
                            <h4>üìç Add Pickup Point by Coordinates</h4>
                            <div class="three-column">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Latitude</label>
                                    <input type="number" id="inputLat" class="input-small" placeholder="28.6139" step="0.0001">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Longitude</label>
                                    <input type="number" id="inputLng" class="input-small" placeholder="77.2090" step="0.0001">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-success" id="addByCoordBtn" style="width: 100%;">
                                        ‚ûï Add Location
                                    </button>
                                </div>
                            </div>
                            <small style="color: #718096; font-size: 12px; margin-top: 8px; display: block;">
                                Enter latitude and longitude, then click "Add Location" to add a pickup point
                            </small>
                        </div>

                        <div class="alert alert-info" id="pickupAlert">
                            Add pickup locations by clicking on map or entering coordinates above
                        </div>

                        <div class="control-buttons">
                            <button class="btn btn-primary" id="addPickupBtn">üìç Add by Map Click</button>
                            <button class="btn btn-secondary" id="optimizeBtn" disabled>üöÄ Optimize Route</button>
                            <button class="btn btn-secondary" id="clearPickupsBtn">üóëÔ∏è Clear All Pickups</button>
                        </div>

                        <div class="pickup-list" id="pickupList" style="display: none;">
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: #2d3748;">Added Pickup Points:</h4>
                        </div>
                    </div>
                </div>

                <!-- Pickups Page - FIXED FORM FIELD NAMES -->
                <div id="pickups" class="page">
                    <div class="card">
                        <h3>üì¶ Submit New Pickup Request</h3>
                        <div class="two-column">
                            <div class="form-group">
                                <label>Donor Name *</label>
                                <input type="text" id="donorName" placeholder="Enter your name" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="donorPhone" placeholder="+91 XXXXX XXXXX" required>
                            </div>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="donorEmail" placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label>Organization Name</label>
                                <input type="text" id="orgName" placeholder="Restaurant/Hotel name">
                            </div>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Donation Type *</label>
                                <select id="donationType" required>
                                    <option value="">Select type</option>
                                    <option value="Cooked Food">Cooked Food</option>
                                    <option value="Raw Vegetables">Raw Vegetables</option>
                                    <option value="Fruits">Fruits</option>
                                    <option value="Packaged Food">Packaged Food</option>
                                    <option value="Medicines">Medicines</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estimated Quantity (kg) *</label>
                                <input type="number" id="quantity" placeholder="e.g., 25" min="0.1" step="0.1" required>
                            </div>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Latitude *</label>
                                <input type="number" id="pickupLat" placeholder="28.6139" step="0.0001" required>
                            </div>
                            <div class="form-group">
                                <label>Longitude *</label>
                                <input type="number" id="pickupLng" placeholder="77.2090" step="0.0001" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Pickup Address</label>
                            <textarea id="address" placeholder="Full address with landmark"></textarea>
                        </div>

                        <div class="two-column">
                            <div class="form-group">
                                <label>Preferred Pickup Time</label>
                                <input type="datetime-local" id="pickupTime">
                            </div>
                            <div class="form-group">
                                <label>Special Instructions</label>
                                <textarea id="notes" placeholder="Any special handling requirements" style="min-height: 60px;"></textarea>
                            </div>
                        </div>

                        <button class="btn btn-primary" id="submitDonorForm">Submit Pickup Request</button>
                    </div>

                    <div class="card">
                        <h3>Recent Pickup Requests</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Donor</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pickupsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NGOs Page -->
                <div id="ngos" class="page">
                    <div class="card">
                        <h3>üè• Partner NGO Network</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>NGO Name</th>
                                    <th>Location</th>
                                    <th>Capacity</th>
                                    <th>Last Pickup</th>
                                    <th>Status</th>
                                    <th>Contact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>City Food Bank NGO</td>
                                    <td>Central Delhi</td>
                                    <td>500 kg/day</td>
                                    <td>2 hours ago</td>
                                    <td><span class="badge success">Active</span></td>
                                    <td>+91 98XXX XXXXX</td>
                                </tr>
                                <tr>
                                    <td>Hope Foundation</td>
                                    <td>North Delhi</td>
                                    <td>300 kg/day</td>
                                    <td>5 hours ago</td>
                                    <td><span class="badge success">Active</span></td>
                                    <td>+91 97XXX XXXXX</td>
                                </tr>
                                <tr>
                                    <td>Care & Share NGO</td>
                                    <td>South Delhi</td>
                                    <td>400 kg/day</td>
                                    <td>1 day ago</td>
                                    <td><span class="badge warning">Limited</span></td>
                                    <td>+91 96XXX XXXXX</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div id="analytics" class="page">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>This Month</h4>
                            <div class="value">89</div>
                            <div class="change">Pickups Completed</div>
                        </div>
                        <div class="stat-card">
                            <h4>Food Saved</h4>
                            <div class="value">1,247 kg</div>
                            <div class="change">This Month</div>
                        </div>
                        <div class="stat-card">
                            <h4>Avg Response Time</h4>
                            <div class="value">42 min</div>
                            <div class="change" style="color: #48bb78;">-8% faster</div>
                        </div>
                        <div class="stat-card">
                            <h4>CO‚ÇÇ Saved</h4>
                            <div class="value">3.2 tons</div>
                            <div class="change">Environmental Impact</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Monthly Trends</h3>
                        <div class="chart-placeholder">
                            üìä Chart visualization would go here<br>
                            (Connect Chart.js or similar library)
                        </div>
                    </div>

                    <div class="card">
                        <h3>Top Donors</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Donor Name</th>
                                    <th>Total Donations</th>
                                    <th>Quantity (kg)</th>
                                    <th>Impact Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ü•á</td>
                                    <td>Grand Hotel</td>
                                    <td>45</td>
                                    <td>892 kg</td>
                                    <td><span class="badge success">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></td>
                                </tr>
                                <tr>
                                    <td>ü•à</td>
                                    <td>City Restaurant Chain</td>
                                    <td>38</td>
                                    <td>745 kg</td>
                                    <td><span class="badge success">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></td>
                                </tr>
                                <tr>
                                    <td>ü•â</td>
                                    <td>Fresh Mart Supermarket</td>
                                    <td>32</td>
                                    <td>680 kg</td>
                                    <td><span class="badge success">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings" class="page">
                    <div class="card">
                        <h3>‚öôÔ∏è System Settings</h3>
                        <div class="form-group">
                            <label>Backend API URL</label>
                            <input type="text" id="apiUrl" value="http://127.0.0.1:8000" placeholder="http://127.0.0.1:8000">
                            <small style="color: #718096; font-size: 12px; display: block; margin-top: 4px;">
                                Change this to your FastAPI backend URL
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Default City</label>
                            <select>
                                <option>Delhi NCR</option>
                                <option>Mumbai</option>
                                <option>Bangalore</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notification Preferences</label>
                            <select>
                                <option>All notifications</option>
                                <option>Critical only</option>
                                <option>Disabled</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Route Optimization Algorithm</label>
                            <select>
                                <option>Shortest Distance</option>
                                <option>Fastest Time</option>
                                <option>Balanced</option>
                            </select>
                        </div>

                        <button class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        let map;
        let userMarker;
        let pickupMarkers = [];
        let ngoMarkers = [];
        let isAddingPickup = false;
        let mapInitialized = false;
        let currentRoutes = [];
        let userLocation = null;

        const ngoLocations = [
            { name: 'City Food Bank NGO', lat: 28.6139, lng: 77.2090 },
            { name: 'Hope Foundation', lat: 28.6280, lng: 77.2200 },
            { name: 'Care & Share NGO', lat: 28.5950, lng: 77.2300 },
            { name: 'Helping Hands', lat: 28.6400, lng: 77.1950 },
            { name: 'Community Kitchen', lat: 28.6050, lng: 77.1850 }
        ];

        const userIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNSIgY3k9IjE1IiByPSIxMiIgZmlsbD0iIzMxODJjZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const ngoIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iNDIiIHZpZXdCb3g9IjAgMCAzMCA0MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMEMxMC44NSAwIDcuMDY1IDIuMDcgNC41IDUuMjVDMS45MzUgOC40MyAwIDEyLjYgMCAxN0MwIDI2LjI1IDE1IDQyIDE1IDQyQzE1IDQyIDMwIDI2LjI1IDMwIDE3QzMwIDEyLjYgMjguMDY1IDguNDMgMjUuNSA1LjI1QzIyLjkzNSAyLjA3IDE5LjE1IDAgMTUgMFpNMTUgMjNDMTEuNyAyMyA5IDIwLjMgOSAxN0M5IDEzLjcgMTEuNyAxMSAxNSAxMUMxOC4zIDExIDIxIDEzLjcgMjEgMTdDMjEgMjAuMyAxOC4zIDIzIDE1IDIzWiIgZmlsbD0iIzQ4YmI3OCIvPjwvc3ZnPg==',
            iconSize: [30, 42],
            iconAnchor: [15, 42],
            popupAnchor: [0, -42]
        });

        const pickupIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iNDIiIHZpZXdCb3g9IjAgMCAzMCA0MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMEMxMC44NSAwIDcuMDY1IDIuMDcgNC41IDUuMjVDMS45MzUgOC40MyAwIDEyLjYgMCAxN0MwIDI2LjI1IDE1IDQyIDE1IDQyQzE1IDQyIDMwIDI2LjI1IDMwIDE3QzMwIDEyLjYgMjguMDY1IDguNDMgMjUuNSA1LjI1QzIyLjkzNSAyLjA3IDE5LjE1IDAgMTUgMFpNMTUgMjNDMTEuNyAyMyA5IDIwLjMgOSAxN0M5IDEzLjcgMTEuNyAxMSAxNSAxMUMxOC4zIDExIDIxIDEzLjcgMjEgMTdDMjEgMjAuMyAxOC4zIDIzIDE1IDIzWiIgZmlsbD0iI2U1M2UzZSIvPjwvc3ZnPg==',
            iconSize: [30, 42],
            iconAnchor: [15, 42],
            popupAnchor: [0, -42]
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function initializeMap() {
            if (mapInitialized) return;
            
            map = L.map('mapView').setView([28.6139, 77.2090], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            ngoLocations.forEach((ngo) => {
                const marker = L.marker([ngo.lat, ngo.lng], { icon: ngoIcon })
                    .addTo(map)
                    .bindPopup(`<b>${ngo.name}</b><br>NGO Distribution Center`);
                ngoMarkers.push(marker);
            });

            document.getElementById('ngoCount').textContent = ngoLocations.length;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        userLocation = { lat, lng };
                        
                        userMarker = L.marker([lat, lng], { icon: userIcon })
                            .addTo(map)
                            .bindPopup('<b>You are here</b>');
                        
                        map.setView([lat, lng], 13);
                        
                        document.getElementById('userLocation').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    },
                    (error) => {
                        document.getElementById('userLocation').textContent = 'Delhi (Default)';
                        userLocation = { lat: 28.6139, lng: 77.2090 };
                    }
                );
            } else {
                userLocation = { lat: 28.6139, lng: 77.2090 };
            }

            map.on('click', (e) => {
                if (isAddingPickup) {
                    addPickupMarker(e.latlng.lat, e.latlng.lng);
                }
            });

            mapInitialized = true;
        }

        function addPickupMarker(lat, lng) {
            const marker = L.marker([lat, lng], { icon: pickupIcon })
                .addTo(map)
                .bindPopup(`<b>Pickup Point #${pickupMarkers.length + 1}</b><br>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`);
            
            pickupMarkers.push({ marker, lat, lng });
            
            updatePickupList();
            
            document.getElementById('pickupCount').textContent = pickupMarkers.length;
            
            if (pickupMarkers.length > 0) {
                document.getElementById('optimizeBtn').disabled = false;
            }
            
            isAddingPickup = false;
            document.getElementById('addPickupBtn').textContent = 'üìç Add by Map Click';
            document.getElementById('addPickupBtn').classList.remove('btn-secondary');
            document.getElementById('addPickupBtn').classList.add('btn-primary');
            document.getElementById('pickupAlert').textContent = 'Add pickup locations by clicking on map or entering coordinates above';
            map.getContainer().style.cursor = '';
            
            showToast(`Pickup point #${pickupMarkers.length} added!`, 'success');
        }

        function updatePickupList() {
            const pickupList = document.getElementById('pickupList');
            
            if (pickupMarkers.length === 0) {
                pickupList.style.display = 'none';
                return;
            }
            
            pickupList.style.display = 'block';
            pickupList.innerHTML = '<h4 style="margin-bottom: 12px; font-size: 14px; color: #2d3748;">Added Pickup Points:</h4>';
            
            pickupMarkers.forEach((pickup, index) => {
                const pickupItem = document.createElement('div');
                pickupItem.className = 'pickup-item';
                
                const info = document.createElement('div');
                info.className = 'pickup-item-info';
                info.innerHTML = `<strong>Pickup #${index + 1}</strong><br>
                                  Lat: ${pickup.lat.toFixed(4)}, Lng: ${pickup.lng.toFixed(4)}`;
                
                const actions = document.createElement('div');
                actions.className = 'pickup-item-actions';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-secondary btn-small';
                removeBtn.textContent = 'üóëÔ∏è Remove';
                removeBtn.onclick = () => removePickup(index);
                
                actions.appendChild(removeBtn);
                
                pickupItem.appendChild(info);
                pickupItem.appendChild(actions);
                pickupList.appendChild(pickupItem);
            });
        }

        function removePickup(index) {
            map.removeLayer(pickupMarkers[index].marker);
            pickupMarkers.splice(index, 1);
            updatePickupList();
            document.getElementById('pickupCount').textContent = pickupMarkers.length;
            
            if (pickupMarkers.length === 0) {
                document.getElementById('optimizeBtn').disabled = true;
            }
            
            showToast('Pickup point removed', 'warning');
        }

        function clearAllPickups() {
            pickupMarkers.forEach(pickup => map.removeLayer(pickup.marker));
            pickupMarkers = [];
            
            currentRoutes.forEach(route => {
                if (route && map.hasLayer(route)) {
                    map.removeControl(route);
                }
            });
            currentRoutes = [];
            
            updatePickupList();
            document.getElementById('pickupCount').textContent = '0';
            document.getElementById('optimizeBtn').disabled = true;
            showToast('All pickup points cleared', 'info');
        }

        // Add by coordinates button
        document.getElementById('addByCoordBtn').addEventListener('click', () => {
            const lat = parseFloat(document.getElementById('inputLat').value);
            const lng = parseFloat(document.getElementById('inputLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showToast('Please enter valid latitude and longitude', 'error');
                return;
            }
            
            if (lat < -90 || lat > 90) {
                showToast('Latitude must be between -90 and 90', 'error');
                return;
            }
            
            if (lng < -180 || lng > 180) {
                showToast('Longitude must be between -180 and 180', 'error');
                return;
            }
            
            addPickupMarker(lat, lng);
            map.setView([lat, lng], 14);
            
            document.getElementById('inputLat').value = '';
            document.getElementById('inputLng').value = '';
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const pageName = this.getAttribute('data-page');
                
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageName).classList.add('active');
                
                const titles = {
                    'dashboard': 'Dashboard Overview',
                    'map': 'Route Optimizer',
                    'pickups': 'Pickup Requests',
                    'ngos': 'NGO Partners',
                    'analytics': 'Analytics & Reports',
                    'settings': 'Settings'
                };
                document.getElementById('pageTitle').textContent = titles[pageName];

                const pageContentArea = document.getElementById('pageContentArea');
                if (pageName === 'map') {
                    pageContentArea.classList.add('map-page');
                    if (!mapInitialized) {
                        setTimeout(() => {
                            initializeMap();
                        }, 100);
                    } else {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                    }
                } else {
                    pageContentArea.classList.remove('map-page');
                }
            });
        });

        document.getElementById('addPickupBtn').addEventListener('click', () => {
            isAddingPickup = !isAddingPickup;
            const btn = document.getElementById('addPickupBtn');
            const alert = document.getElementById('pickupAlert');
            
            if (isAddingPickup) {
                btn.textContent = '‚ùå Cancel';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                alert.textContent = 'Click anywhere on the map to add a pickup point!';
                alert.className = 'alert alert-success';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'üìç Add by Map Click';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                alert.textContent = 'Add pickup locations by clicking on map or entering coordinates above';
                alert.className = 'alert alert-info';
                map.getContainer().style.cursor = '';
            }
        });

        document.getElementById('clearPickupsBtn').addEventListener('click', clearAllPickups);

        document.getElementById('optimizeBtn').addEventListener('click', () => {
            if (pickupMarkers.length === 0) {
                showToast('Please add pickup points first!', 'error');
                return;
            }

            if (!userLocation) {
                showToast('Waiting for user location...', 'warning');
                return;
            }

            currentRoutes.forEach(route => {
                if (route && map.hasLayer(route)) {
                    map.removeControl(route);
                }
            });
            currentRoutes = [];

            let routeInfo = [];
            let routesCompleted = 0;

            pickupMarkers.forEach((pickup, index) => {
                const pickupLat = pickup.lat;
                const pickupLng = pickup.lng;

                let nearestNGO = null;
                let minDistance = Infinity;

                ngoLocations.forEach((ngo) => {
                    const distance = Math.sqrt(
                        Math.pow(ngo.lat - pickupLat, 2) + 
                        Math.pow(ngo.lng - pickupLng, 2)
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestNGO = ngo;
                    }
                });

                if (nearestNGO) {
                    const routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userLocation.lat, userLocation.lng),
                            L.latLng(pickupLat, pickupLng),
                            L.latLng(nearestNGO.lat, nearestNGO.lng)
                        ],
                        routeWhileDragging: false,
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false,
                        showAlternatives: false,
                        lineOptions: {
                            styles: [{ 
                                color: index === 0 ? '#3182ce' : index === 1 ? '#48bb78' : index === 2 ? '#ed8936' : '#9f7aea', 
                                opacity: 0.7, 
                                weight: 4 
                            }]
                        },
                        createMarker: function() { return null; }
                    }).addTo(map);

                    currentRoutes.push(routingControl);

                    routingControl.on('routesfound', function(e) {
                        const routes = e.routes;
                        const summary = routes[0].summary;
                        const distanceKm = (summary.totalDistance / 1000).toFixed(2);
                        const timeMin = Math.round(summary.totalTime / 60);
                        
                        routeInfo.push(`Pickup #${index + 1}: ${distanceKm} km, ~${timeMin} min ‚Üí ${nearestNGO.name}`);
                        
                        pickup.marker.bindPopup(
                            `<b>Pickup Point #${index + 1}</b><br>
                            Route: You ‚Üí Pickup ‚Üí ${nearestNGO.name}<br>
                            Distance: ${distanceKm} km<br>
                            Time: ~${timeMin} minutes`
                        );

                        routesCompleted++;
                        if (routesCompleted === pickupMarkers.length) {
                            setTimeout(() => {
                                const routeSummary = `‚úÖ Routes Optimized!\n\n${routeInfo.join('\n')}`;
                                alert(routeSummary);
                            }, 500);
                        }
                    });
                }
            });

            showToast('Creating optimized routes...', 'success');
        });

        // FIXED: Form submission with correct field names matching backend
        document.getElementById('submitDonorForm').addEventListener('click', async () => {
            // Get values
            const name = document.getElementById('donorName').value.trim();
            const phone = document.getElementById('donorPhone').value.trim();
            const email = document.getElementById('donorEmail').value.trim();
            const organization = document.getElementById('orgName').value.trim();
            const donation_type = document.getElementById('donationType').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const latitude = parseFloat(document.getElementById('pickupLat').value);
            const longitude = parseFloat(document.getElementById('pickupLng').value);
            const address = document.getElementById('address').value.trim();
            const pickup_time = document.getElementById('pickupTime').value || null;
            const notes = document.getElementById('notes').value.trim();

            // Validation - check required fields
            if (!name) {
                showToast('Please enter donor name', 'error');
                return;
            }
            if (!phone) {
                showToast('Please enter phone number', 'error');
                return;
            }
            if (!donation_type) {
                showToast('Please select donation type', 'error');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                showToast('Please enter valid quantity', 'error');
                return;
            }
            if (isNaN(latitude)) {
                showToast('Please enter valid latitude', 'error');
                return;
            }
            if (isNaN(longitude)) {
                showToast('Please enter valid longitude', 'error');
                return;
            }

            // Create request body matching backend schema exactly
            const formData = {
                name: name,
                phone: phone,
                email: email || null,
                organization: organization || null,
                donation_type: donation_type,
                quantity: quantity,
                latitude: latitude,
                longitude: longitude,
                address: address || null,
                pickup_time: pickup_time,
                notes: notes || null
            };

            console.log('Sending data:', formData);

            try {
                const apiUrl = document.getElementById('apiUrl')?.value || API_BASE_URL;
                const response = await fetch(`${apiUrl}/pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('Response:', result);

                if (response.ok) {
                    showToast('‚úÖ Pickup request submitted successfully!', 'success');
                    
                    // Clear form
                    document.getElementById('donorName').value = '';
                    document.getElementById('donorPhone').value = '';
                    document.getElementById('donorEmail').value = '';
                    document.getElementById('orgName').value = '';
                    document.getElementById('donationType').value = '';
                    document.getElementById('quantity').value = '';
                    document.getElementById('pickupLat').value = '';
                    document.getElementById('pickupLng').value = '';
                    document.getElementById('address').value = '';
                    document.getElementById('notes').value = '';
                    document.getElementById('pickupTime').value = '';

                    loadPickups();
                } else {
                    let errorMsg = 'Failed to submit pickup request';
                    
                    if (result.detail) {
                        if (Array.isArray(result.detail)) {
                            errorMsg = result.detail.map(err => {
                                const field = err.loc ? err.loc[err.loc.length - 1] : 'unknown';
                                return `${field}: ${err.msg}`;
                            }).join('\n');
                        } else if (typeof result.detail === 'string') {
                            errorMsg = result.detail;
                        }
                    }
                    
                    console.error('Validation errors:', result);
                    alert('‚ùå Error:\n\n' + errorMsg);
                    showToast('Failed to submit', 'error');
                }
            } catch (error) {
                console.error('Error submitting pickup:', error);
                showToast('‚ùå Cannot connect to backend. Check API URL in Settings.', 'error');
            }
        });

        async function loadPickups() {
            try {
                const apiUrl = document.getElementById('apiUrl')?.value || API_BASE_URL;
                const response = await fetch(`${apiUrl}/pickups`);
                
                if (response.ok) {
                    const pickups = await response.json();
                    const tbody = document.getElementById('pickupsTableBody');
                    
                    if (pickups.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No pickups found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = pickups.map(pickup => `
                        <tr>
                            <td>#${pickup.pickup_id || pickup.id || 'N/A'}</td>
                            <td>${pickup.name || pickup.donor_name || 'N/A'}</td>
                            <td>${pickup.donation_type || 'N/A'}</td>
                            <td>${pickup.quantity || pickup.quantity_kg || 'N/A'} kg</td>
                            <td>${pickup.address ? pickup.address.substring(0, 30) + '...' : `${pickup.latitude}, ${pickup.longitude}` || 'N/A'}</td>
                            <td><span class="badge info">${pickup.status || 'Pending'}</span></td>
                            <td><button class="btn btn-secondary" style="padding: 6px 12px;">View</button></td>
                        </tr>
                    `).join('');
                } else {
                    console.log('Failed to load pickups');
                }
            } catch (error) {
                console.error('Error loading pickups:', error);
            }
        }

        window.addEventListener('load', () => {
            loadPickups();
        });
    </script>
</body>
</html>